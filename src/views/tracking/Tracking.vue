<template>
  <div>
    <!--begin::Wrapper-->
    <div class="container p-lg-10 mt-5">
      <h2 class="mt-10 mb-5 text-black">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≤‡∏∞‡πÅ‡∏™</h2>

      <div class="card">
        <div class="card-body bg-sky px-5 py-5 pt-10">
          <div class="div-search">
            <div class="mb-10">
              <h4 class="text-center">
                ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô/‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
              </h4>
            </div>
            <div class="d-flex justify-content-center mb-7">
              <div
                class="form-check form-check-custom form-check-solid me-5 mb-2"
              >
                <input
                  class="form-check-input"
                  name="type_of_track"
                  type="radio"
                  value="1"
                  checked
                  v-model="search.type_of_track"
                  id="flexCheckboxLg"
                />
                <label class="form-check-label fs-5" for="flexCheckboxLg">
                  ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </label>
              </div>
              <div class="form-check form-check-custom form-check-solid mb-2">
                <input
                  class="form-check-input"
                  name="type_of_track"
                  type="radio"
                  value="2"
                  v-model="search.type_of_track"
                  id="flexCheckboxLg"
                />
                <label class="form-check-label fs-5" for="flexCheckboxLg">
                  ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô/‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
                </label>
              </div>
            </div>
            <div class="mb-7 d-flex justify-content-center">
              <input
                style="max-width: 600px"
                type="text"
                class="form-control"
                placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô/‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á"
                aria-label="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô/‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á"
                aria-describedby="basic-addon2"
                v-model="search.id_card_or_jcoms_no"
              />
            </div>
            <div class="d-flex justify-content-center">
              <button class="btn btn-bg-primary text-white" @click="onSearch">
                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
            </div>
          </div>
          <div class="separator my-10 mt-5"></div>

          <div class="row">
            <div class="col-md-12 mb-5">
              <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≤‡∏∞‡πÅ‡∏™</h4>
            </div>
            <div class="col-md-12 table-responsive">
              <Preloader :isLoading="isLoading" :position="'absolute'" />
              <ListComponent
                :items="items"
                :paginationData="paginationData"
                @update:currentPage="paginationData.currentPage = $event"
                @detail="
                (it: any) => {
                  Object.assign(item, it);
                  openDetailModal = true;
                }
              "
              />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="detail-modal">
      <!-- item.tracking_satisfaction == null ?
      //   onEvalModal() : ""  -->
      <DetailPage
        v-if="
          openDetailModal == true &&
          item.id != null &&
          item.complainant_id != null
        "
        :complaint_id="item.id"
        :complainant_id="item.complainant_id"
        @update-tracking-satisfaction="(event: any) => {
              item.tracking_satisfaction = event
          }"
        @close-modal="
          () => {
            openDetailModal = false;
            onEvalModal();
          }
        "
      />
    </div>

    <div id="otp-before-fetch-complaint">
      <Otp
        v-if="openOtpModal"
        :request_otp="request_otp"
        @close-otp-modal="
          () => {
            openOtpModal = false;
          }
        "
        @fetch-complaint="fetchItems"
      />
    </div>

    <!-- Modal Evaluate -->
    <div
      class="modal fade"
      tabindex="-1"
      ref="evalModalRef"
      id="eval-modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">
              ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≤‡∏∞‡πÅ‡∏™
            </h3>
          </div>

          <div class="modal-body">
            <div class="row">
              <div class="col-md-12 text-center mt-3">
                <div class="mb-3">‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà EMOJI <br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                <div class="text-center mx-auto">
                  <span
                    v-for="(emoji, index) in emojis"
                    :key="index"
                    @click="setRating(index + 1)"
                    class="rating-emoji"
                  >
                    {{ emoji }}
                  </span>
                </div>
                <div>
                  <h4>{{ rating_text }}</h4>
                </div>
                <!--  -->
                <div class="separator separator-dotted my-2"></div>
              </div>
              <div class="col-md-12 text-center mt-5">
                <button
                  class="btn btn-success"
                  @click="onEvalConfirm"
                  :disabled="rating > 0 ? false : true"
                >
                  ‡∏ï‡∏Å‡∏•‡∏á
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--end::Wrapper-->

    <div id="captcha">
      <!-- first_action -->
      <Captcha
        v-if="captcha_modal"
        @close-captcha-modal="
          () => {
            captcha_modal = false;
          }
        "
      />
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent, ref, onMounted, reactive, watch } from "vue";
import ApiService from "@/core/services/ApiService";
// Import Dayjs
import dayjs from "dayjs";
import "dayjs/locale/th";
import buddhistEra from "dayjs/plugin/buddhistEra";
dayjs.extend(buddhistEra);
// Import Modal Bootstrap
import { Modal } from "bootstrap";

// Composable
import useToast from "@/composables/useToast";
// Component
import Preloader from "@/components/preloader/Preloader.vue";
import Otp from "@/components/tracking/Otp.vue";
import ListComponent from "@/components/tracking/List.vue";
import DetailPage from "@/views/tracking/DetailModal.vue";
import Captcha from "@/components/tracking/Captcha.vue";

export default defineComponent({
  name: "tracking",
  components: {
    dayjs,
    Otp,
    ListComponent,
    DetailPage,
    Preloader,
    Captcha,
  },
  setup() {
    // UI
    const isLoading = ref<any>(false);
    const openOtpModal = ref(false);
    const openDetailModal = ref(false);
    const evalModalRef = ref<any>(null);
    const evalModalObj = ref<any>(null);
    const captcha_modal = ref(false);

    const checkComplainantUUID = ref(null);
    const request_otp = reactive<any>({
      jcoms_no: undefined,
      id_card: undefined,
      phone_number_show: undefined,
    });
    // Variable

    const rating = ref(0);
    const rating_text = ref("");
    const setRating = (value) => {
      rating.value = value;
      if (value == 1) {
        rating_text.value = "‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à‡∏°‡∏≤‡∏Å";
      }
      if (value == 2) {
        rating_text.value = "‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à";
      }
      if (value == 3) {
        rating_text.value = "‡∏û‡∏≠‡πÉ‡∏ä‡πâ";
      }
      if (value == 4) {
        rating_text.value = "‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à";
      }
      if (value == 5) {
        rating_text.value = "‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏°‡∏≤‡∏Å";
      }
      console.log("Selected rating:", value);
    };

    // const rating = ref(0);
    const search = reactive({ type_of_track: 1, id_card_or_jcoms_no: "" });
    const items = reactive<any>([]);
    const item = ref({
      id: null,
      complainant_id: null,
      tracking_satisfaction: null,
    });

    // const setRating = (rate: number) => {
    //   rating.value = rate;
    // };

    const paginationData = reactive<any>({
      perPage: 20,
      currentPage: 1,
      totalPage: 1,
      totalItems: 0,
    });

    // Fetch
    const fetchItems = async (complainant_uuid: any) => {
      isLoading.value = true;

      await ApiService.query("complaint/get-complaint-by-otp", {
        params: {
          complainant_uuid: complainant_uuid,
          perPage: paginationData.perPage,
          currentPage: paginationData.currentPage,
          orderBy: "created_at",
          order: "desc",
        },
      })
        .then(({ data }) => {
          if (data.msg != "success") {
            throw new Error("ERROR");
          }

          items.length = 0;
          Object.assign(items, data.data);
          paginationData.totalPage = data.totalPage;
          paginationData.totalItems = data.totalData;
          paginationData.currentPage = data.currentPage;

          checkComplainantUUID.value = getComplainantUUIDWithExpiry();
          isLoading.value = false;
        })
        .catch(({ response }) => {
          console.log(response);
        });
    };

    // Event
    const onSearch = async () => {
      if (
        search.type_of_track == null ||
        search.id_card_or_jcoms_no == null ||
        search.id_card_or_jcoms_no == ""
      ) {
        useToast("‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "error");
        return;
      }

      Object.assign(items, []);

      Object.assign(request_otp, {
        jcoms_no: undefined,
        id_card: undefined,
        phone_number: undefined,
        phone_number_show: undefined,
      });

      if (search.type_of_track == 1) {
        request_otp.jcoms_no = search.id_card_or_jcoms_no;
      } else if (search.type_of_track == 2) {
        request_otp.id_card = search.id_card_or_jcoms_no;
      } else if (search.type_of_track == 3) {
        request_otp.phone_number_show = search.id_card_or_jcoms_no;
      } else {
        useToast("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error");
        return;
      }

      // Generate a random string of 4 English characters
      await ApiService.post("complaint/get-phonenumber", {
        ...request_otp,
      })
        .then(({ data }) => {
          if (data.msg != "success") {
            throw new Error("ERROR");
          }

          request_otp.phone_number_show = data.data.phone_number;
          openOtpModal.value = true;
        })
        .catch(({ response }) => {
          useToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
          console.log(response);
        });
    };

    const getComplainantUUIDWithExpiry = () => {
      const itemStr = localStorage.getItem("complainant_uuid");
      // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô LocalStorage
      if (!itemStr) {
        return null;
      }
      const item = JSON.parse(itemStr);
      const now = new Date();

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
      if (now.getTime() > item.expiry) {
        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ null
        localStorage.removeItem("complainant_uuid");
        return null;
      }

      return item.value;
    };

    const onEvalModal = () => {
      //   if (item.value.tracking_satisfaction == null) {

      evalModalObj.value.show();

      //   }
    };

    const onEvalConfirm = async () => {
      // save Eval
      let eval_data = {
        tracking_satisfaction: rating.value,
        tracking_satisfaction_at: dayjs().format("YYYY-MM-DD HH:mm:ss"),
      };
      //   fetch

      await ApiService.post("complaint/" + item.value.id, eval_data)
        .then(async ({ data }) => {
          if (data.msg != "success") {
            throw new Error("ERROR");
          }
          evalModalObj.value.hide();
        })
        .catch(({ response }) => {
          console.log(response);
        });
    };

    // Mounted
    onMounted(async () => {
      evalModalObj.value = new Modal(evalModalRef.value, {});
      checkComplainantUUID.value = getComplainantUUIDWithExpiry();
      if (checkComplainantUUID.value != null) {
        fetchItems(checkComplainantUUID.value);
      } else {
        captcha_modal.value = true;
      }
    });

    // Watch
    watch(
      () => paginationData.currentPage,
      () => {
        fetchItems(checkComplainantUUID.value);
      }
    );

    const emojis = ["üò°", "üòü", "üòê", "üòä", "üòÅ"];

    return {
      search,
      item,
      items,
      request_otp,
      rating,
      paginationData,
      isLoading,
      onSearch,
      fetchItems,
      openDetailModal,
      openOtpModal,
      onEvalModal,
      onEvalConfirm,
      setRating,
      evalModalRef,
      evalModalObj,
      captcha_modal,
      emojis,
      rating_text,
    };
  },
});
</script>

<style>
@media only screen and (max-width: 768px) {
  .card > .card-body {
    padding: 0px;
  }
}
.vs__dropdown-toggle {
  border: none;
}

.v-select {
  padding: 0.4em 0.5em;
}

.dp__main {
  padding: 0.35em 0em;
}

.dp__input {
  border: none !important;
}

.bg-color-police {
  background-color: #800001;
}

.bg-sky {
  background-color: #d9f4fe;
}

.rating-container {
  display: flex;
  justify-content: center;
  align-items: center;
}
.rating-emoji {
  font-size: 4rem;
  cursor: pointer;
  margin: 0 0.5rem;
}
</style>
